<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>用户列表</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="lib/layui/css/layui.css">
    <link rel="stylesheet" href="css/scroll-bar.css">
    <link rel="stylesheet" href="css/sub-page.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_693759_wytlyqhtdtj1nhfr.css">
</head>
<body>
<div class="ok-body">
    <!--模糊搜索区域-->
    <div class="layui-row">
        <form class="layui-form layui-col-md12 ok-search">
            <label class="layui-form-label">请选择学科:</label>
            <select name="subject" lay-filter="selectSubject" lay-verify="" id="subject">
            </select>
            <label class="layui-form-label">请选择出版社:</label>
            <select name="publish" lay-filter="selectPublish" lay-verify="" id="publish">
            </select>
            <label class="layui-form-label">请选择学段:</label>
            <select name="section" lay-filter="selectSection" lay-verify="" id="section">
            </select>
            <label class="layui-form-label">请选择年级:</label>
            <select name="grade" lay-filter="selectGrade" lay-verify="" id="grade">
            </select>
            <button class="layui-btn" lay-submit="" lay-filter="search">
                <i class="layui-icon layui-icon-search">查询</i>
            </button>
        </form>
    </div>
    <!--工具栏-->
    <okToolbar>
        <button class="layui-btn layui-btn-normal" id="batchEnabled">
            <i class="iconfont icon-shangsheng"></i>批量导出
        </button>
        <span>共有数据：<i id="countNum"></i> 条</span>
    </okToolbar>
    <!--数据表格-->
    <table class="layui-hide" id="tableId" lay-filter="tableFilter"></table>
</div>
<!--js逻辑-->
<script src="lib/layui/layui.js"></script>
<script>

    layui.use(['element', 'table', 'form', 'jquery', 'laydate'], function () {
        var element = layui.element;
        var table = layui.table;
        var form = layui.form;
        var $ = layui.jquery;
        var laydate = layui.laydate;

        /*加载学科下拉框选项*/
        $.ajax({
            type: 'get',
            url: 'selectSubject',
            dataType:  'json',
            success: function(data){
                $("#subject").html("");
                $.each(data, function(idx, val) {
                    var option1 = $("<option>").val(val.id).text(val.subject);
                    $("#subject").append($("<option>"));
                    $("#subject").append(option1);
                    form.render('select');
                });
            }
        });

        /*加载出版社下拉框选项*/
        $.ajax({
            type: 'get',
            url: 'selectPublish',
            dataType:  'json',
            success: function(data){
                $("#publish").html("");
                $.each(data, function(idx, val) {
                    var option1 = $("<option>").val(val.id).text(val.publish);
                    $("#publish").append($("<option>"));
                    $("#publish").append(option1);
                    form.render('select');
                });
            }
        });

        /*加载学段和年级下拉框选项*/
        $.ajax({
            type: 'get',
            url: 'ApiV1/selectDistinctSectionAndGrade',
            dataType:  'json',
            success: function(data){
                $("#section").html("");
                $("#grade").html("");
                var sections = data.sections;
                var grades = data.grades;
                $.each(sections, function(idx, val) {
                    var option1 = $("<option>").val(val).text(val);
                    $("#section").append($("<option>"));
                    $("#section").append(option1);
                    form.render('select');
                });
                $.each(grades, function(idx, val) {
                    var option2 = $("<option>").val(val).text(val);
                    $("#grade").append($("<option>"));
                    $("#grade").append(option2);
                    form.render('select');
                });
            }
        });


        /*点击查询按钮触发事件*/
        form.on('submit(search)', function () {
            var subjectId = $('#subject').val();
            var publishId = $('#publish').val();
            var section = $('#section').val();
            var grade = $('#grade').val();

            table.render({
                elem: '#tableId',
                url: 'ApiV1/GetIndex',
                where: {
                    'ak': 111,
                    'subjectId': subjectId,
                    'publishId': publishId,
                    'section': section,
                    'grade': grade
                },
                method: 'post',
                limit: 20,
                page: true,
                even: true,
                cols: [[
                    {type: 'checkbox'},
                    {field: 'id', title: 'ID', width: 80, sort: true},
                    {field: 'caption', title: '教材名称'},
                    {field: 'cover', title: '封面文件名'},
                    {field: 'edition', title: '教材版本'},
                    {field: 'section', title: '学段'},
                    {field: 'grade', title: '年级'},
                    {field: 'publish', title: '出版社'},
                    {field: 'subject', title: '学科'},
                    {field: 'md5', title: '文件的MD5值'},
                    {field: 'size', title: '文件大小'},
                    {title: '操作', templet: '#operationTpl', align: 'center'}
                ]],
                done: function (res, curr, count) {
                    $("#countNum").text(count);
                }
            })
            return false;
        })

        table.on('tool(tableFilter)', function (obj) {
            var data = obj.data;
            var layEvent = obj.event;
            if (layEvent === 'edit') {
                layer.open({
                    title: '编辑用户',
                    type: 2,
                    shade: false,
                    maxmin: true,
                    shade: 0.5,
                    area: ['90%', '90%'],
                    content: 'user-edit.html',
                    zIndex: layer.zIndex,
                    end: function () {
                        // $(".layui-laypage-btn")[0].click();
                    }
                });
            } else if (layEvent === 'del') {
                layer.confirm("确定要删除吗？", {skin: 'layui-layer-lan', icon: 2, title: '提示', anim: 6}, function (index) {
                    $.post('ApiV1/deleteBook',{bookId:data.id},function(){
                        obj.del();
                        layer.close(index);
                    })
                });
            }
        });
        /*点击批量导出按钮触发事件*/
        /*$("#batchEnabled").click(function () {
            if(ids.length == 0){
                layer.msg("请选择导出的文件!");
            }else{
                layer.prompt({title: '导出文件名'},function(val, index){
                    var directory = val;
                    layer.close(index);
                    layer.confirm("确定要批量导出吗？", {skin: 'layui-layer-lan', icon: 3, title: '提示', anim: 1}, function () {
                        var index = layer.load();
                        $.post("ApiV1/exportBookList", {bookIds: ids,directory:directory}, function (data) {
                            layer.close(index);
                            layer.msg(data.msg,{ time: 5000 });
                        })
                    });
                });
            }
        })*/


    })
</script>
<!--模板-->
<script type="text/html" id="operationTpl">
    <a href="javascript:;" title="编辑" lay-event="edit"><i class="layui-icon">&#xe642;</i></a>
    <a href="javascript:;" title="删除" lay-event="del"><i class="layui-icon">&#xe640;</i></a>
</script>
</body>
</html>